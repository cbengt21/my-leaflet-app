<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenStreetMap Web App with Real-Time Location Updates</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet Control Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <style>
        #map {
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet Control Geocoder JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <script>
        let map, userMarker, routingControl;
        let isMapInitialized = false;  // Flag to prevent constant map centering

        // Function to initialize or update the map with the user's location
        function initMap(lat, lon) {
            // If the map doesn't exist yet, initialize it
            if (!map) {
                map = L.map('map').setView([lat, lon], 13);

                // Load OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Add the Leaflet Control Geocoder (Search Box)
                const geocoder = L.Control.geocoder({
                    defaultMarkGeocode: false
                }).on('markgeocode', function(e) {
                    const latlng = e.geocode.center;
                    map.setView(latlng, 13);

                    // Add a marker for the searched location
                    L.marker(latlng).addTo(map).bindPopup('Search result: ' + e.geocode.name).openPopup();

                    // Remove the previous route if there is one
                    if (routingControl) {
                        map.removeControl(routingControl);
                    }

                    // Create a new route from the user's location to the searched location
                    routingControl = L.Routing.control({
                        waypoints: [
                            L.latLng(userMarker.getLatLng()),  // Start at the user's current location
                            latlng                             // End at the searched location
                        ],
                        routeWhileDragging: true
                    }).addTo(map);
                }).addTo(map);
            }

            // If the user marker doesn't exist yet, create it
            if (!userMarker) {
                userMarker = L.marker([lat, lon]).addTo(map).bindPopup('You are here!').openPopup();
            } else {
                // If the marker exists, just update its position
                userMarker.setLatLng([lat, lon]);
            }

            // Only center the map the first time the location is retrieved
            if (!isMapInitialized) {
                map.setView([lat, lon], 13);  // Center the map the first time
                isMapInitialized = true;  // Mark the map as initialized
            }
        }

        // Use the Geolocation API to track the user's current position and update the map in real-time
        if (navigator.geolocation) {
            // Watch the user's position and update the map as they move
            navigator.geolocation.watchPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // Update the map and marker with the user's current position
                    initMap(lat, lon);
                },
                function(error) {
                    alert("Failed to retrieve location: " + error.message);

                    // Fallback: if geolocation fails, load the map at a default location (London)
                    initMap(51.505, -0.09);
                },
                {
                    enableHighAccuracy: true,  // Use GPS for higher accuracy
                    maximumAge: 0,             // Prevent using old positions
                    timeout: 10000             // Timeout if no position is found within 10 seconds
                }
            );
        } else {
            alert("Geolocation is not supported by this browser.");
            // Fallback: if geolocation is not supported, load the map at a default location (London)
            initMap(51.505, -0.09);
        }
    </script>
</body>
</html>
